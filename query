SELECT 
    cg.ID as CG_ID, 
    cg.name as CG_NAME, 
    cg.ECN as CG_ECN, 
    cg.portfolio_cd as CG_PORTFOLIO_CD, 
    cg.RM as CG_EM, 
    cg.MANAGED as CG_MANAGED, 
    cg.customer_or_prospect_rs as CG_PROSPECT, 
    cg.IS_CUSTOMER, 
    cg.BNK_REV_RS as BANK_REVENUE, 
    cg.TOTAL_GROSS_SALES_RS as CG_GROSS_SALES, 
    usr.FIRSTNAME as BANKER_FORSTNAME, 
    usr.LASTNAME as BANKER_LASTNAME, 
    acc.BILLINGSTREET, 
    acc.BILLINGCITY, 
    acc.BILLINGSTATE, 
    acc.BILLINGPOSTALCODE, 
    mtb.management_chain_level_06, 
    mtb.management_chain_level_07, 
    mtb.type
FROM 
    SCH_CRV_SFDC.T_CRV_BKP_CLIENT_GROUP@crv_p01bobgi cg
INNER JOIN -- Changed from subquery to join condition
    (SELECT employee_id FROM Manager_to_banker_alignment_auto WHERE AU != 0 AND employee_id = 1) emp_filter
    ON CAST(usr.employeenumber AS INT) = emp_filter.employee_id
LEFT JOIN 
    CRM_LITE.V_CRV_BKP_ACCOUNT@crv_p01bobgi acc
    ON cg.ECN = acc.ECN
LEFT JOIN 
    SCH_CRV_SFDC.T_CRV_BKP_USER@crv_p01bobgi usr
    ON cg.ownerid = usr.id
LEFT JOIN 
    (SELECT * FROM Manager_to_banker_alignment_auto WHERE AU != 0 AND employee_id != 1) mtb
    ON CAST(usr.employeenumber AS INT) = mtb.employee_id
WHERE 
    cg.isdeleted = 0
-------------------------------------------------------------------------

WITH PORTFOLIO_CODES AS (
    SELECT DISTINCT A.PORT_ID AS PORTFOLIO_CD
    FROM BANKER.BP_BBSG_INV A
    INNER JOIN BANKER.T_EMP B ON A.EMP_ID = B.EMP_ID
    WHERE A.PORT_TYP_CD IN ('BUSCBRM', 'BUSSTRA', 'BUSVIRT')
    AND A.PORT_ID_STAT IN ('A', 'L')
),
CLIENT_GROUPS AS (
    SELECT id AS client_group_id, ECN AS CG_ECN, PORTFOLIO_CD
    FROM CRM_LITE.VT_CRV_BKP_CLIENT_GROUP@crv_p01bobgi CG
    WHERE EXISTS (
        SELECT 1 FROM PORTFOLIO_CODES PC 
        WHERE CG.PORTFOLIO_CD = PC.PORTFOLIO_CD
    )
)
SELECT 
    CG.CG_ECN, 
    A.ECN, 
    CG.PORTFOLIO_CD, 
    RC.client_group
FROM CLIENT_GROUPS CG
JOIN CRM_LITE.V_CRV_BKP_RELATED_CLIENT@crv_p01bobgi RC ON RC.client_group = CG.client_group_id
JOIN CRM_LITE.V_CRV_BKP_ACCOUNT@crv_p01bobgi A ON RC.customer = A.id;


WITH PORTFOLIO_CODES AS (
    SELECT DISTINCT A.PORT_ID AS PORTFOLIO_CD
    FROM BANKER.BP_BBSG_INV A
    INNER JOIN BANKER.T_EMP B ON A.EMP_ID = B.EMP_ID
    WHERE A.PORT_TYP_CD IN ('BUSCBRM', 'BUSSTRA', 'BUSVIRT')
    AND A.PORT_ID_STAT IN ('A', 'L')
),
CLIENT_GROUPS AS (
    SELECT id AS client_group_id, ECN AS CG_ECN, PORTFOLIO_CD
    FROM CRM_LITE.VT_CRV_BKP_CLIENT_GROUP@crv_p01bobgi CG
    WHERE EXISTS (
        SELECT 1 FROM PORTFOLIO_CODES PC 
        WHERE CG.PORTFOLIO_CD = PC.PORTFOLIO_CD
    )
)
SELECT 
    CG.CG_ECN, 
    A.ECN, 
    CG.PORTFOLIO_CD, 
    RC.client_group,
    CASE WHEN CG.CG_ECN IS NULL THEN 'Missing CG_ECN' ELSE 'Has CG_ECN' END AS ECN_STATUS
FROM CLIENT_GROUPS CG
JOIN CRM_LITE.V_CRV_BKP_RELATED_CLIENT@crv_p01bobgi RC ON RC.client_group = CG.client_group_id
JOIN CRM_LITE.V_CRV_BKP_ACCOUNT@crv_p01bobgi A ON RC.customer = A.id
ORDER BY CASE WHEN CG.CG_ECN IS NULL THEN 0 ELSE 1 END, A.ECN;



WITH PORTFOLIO_CODES AS (
    SELECT DISTINCT A.PORT_ID AS PORTFOLIO_CD
    FROM BANKER.BP_BBSG_INV A
    INNER JOIN BANKER.T_EMP B ON A.EMP_ID = B.EMP_ID
    WHERE A.PORT_TYP_CD IN ('BUSCBRM', 'BUSSTRA', 'BUSVIRT')
    AND A.PORT_ID_STAT IN ('A', 'L')
),
CLIENT_GROUPS AS (
    SELECT id AS client_group_id, ECN AS CG_ECN, PORTFOLIO_CD
    FROM CRM_LITE.VT_CRV_BKP_CLIENT_GROUP@crv_p01bobgi CG
    WHERE EXISTS (
        SELECT 1 FROM PORTFOLIO_CODES PC 
        WHERE CG.PORTFOLIO_CD = PC.PORTFOLIO_CD
    )
)
SELECT 
    CG.CG_ECN, 
    A.ECN, 
    CG.PORTFOLIO_CD, 
    RC.client_group,
    CASE WHEN SEGS.ECN IS NOT NULL THEN 1 ELSE 0 END AS PRESENT_IN_SEG,
    SEGS.DEPOSIT_BAL,
    SEGS.CS_NEW_NS,
    RC.BANK_REV,
    RC.GROSS_SALES
FROM CLIENT_GROUPS CG
JOIN CRM_LITE.V_CRV_BKP_RELATED_CLIENT@crv_p01bobgi RC ON RC.client_group = CG.client_group_id
JOIN CRM_LITE.V_CRV_BKP_ACCOUNT@crv_p01bobgi A ON RC.customer = A.id
LEFT JOIN SEGMENT_CUST_SBS SEGS ON A.ECN = SEGS.ECN;


#############################################
WITH PORTFOLIO_CODES AS (
    SELECT DISTINCT A.PORT_ID AS PORTFOLIO_CD
    FROM BANKER.BP_BBSG_INV A
    INNER JOIN BANKER.T_EMP B ON A.EMP_ID = B.EMP_ID
    WHERE A.PORT_TYP_CD IN ('BUSCBRM', 'BUSSTRA', 'BUSVIRT')
    AND A.PORT_ID_STAT IN ('A', 'L')
)
SELECT 
    CG.ECN AS CG_ECN, 
    A.ECN, 
    CG.PORTFOLIO_CD, 
    CG.id AS client_group_id,
    CASE WHEN SEGS.ECN IS NOT NULL THEN 1 ELSE 0 END AS PRESENT_IN_SEG,
    SEGS.DEPOSIT_BAL,
    SEGS.CS_NEW_NS,
    A.BILLINGSTREET,
    A.BILLINGCITY,
    A.BILLINGSTATE
FROM CRM_LITE.VT_CRV_BKP_CLIENT_GROUP@crv_p01bobgi CG
JOIN PORTFOLIO_CODES PC ON CG.PORTFOLIO_CD = PC.PORTFOLIO_CD
JOIN CRM_LITE.V_CRV_BKP_ACCOUNT@crv_p01bobgi A ON A.client_group = CG.id
LEFT JOIN SEGMENT_CUST_SBS SEGS ON A.ECN = SEGS.ECN;
