WITH PORTFOLIO_CODES AS (
    SELECT DISTINCT A.PORT_ID AS PORTFOLIO_CD
    FROM BANKER.BP_BBSG_INV A
    INNER JOIN BANKER.T_EMP B ON A.EMP_ID = B.EMP_ID
    WHERE A.PORT_TYP_CD IN ('BUSCBRM', 'BUSSTRA', 'BUSVIRT')
    AND A.PORT_ID_STAT IN ('A', 'L')
),
CLIENT_GROUPS AS (
    SELECT id AS client_group_id, ECN AS CG_ECN, PORTFOLIO_CD
    FROM CRM_LITE.VT_CRV_BKP_CLIENT_GROUP@crv_p01bobgi CG
    WHERE EXISTS (
        SELECT 1 FROM PORTFOLIO_CODES PC 
        WHERE CG.PORTFOLIO_CD = PC.PORTFOLIO_CD
    )
)
SELECT 
    CG.CG_ECN, 
    A.ECN, 
    CG.PORTFOLIO_CD, 
    RC.client_group
FROM CLIENT_GROUPS CG
JOIN CRM_LITE.V_CRV_BKP_RELATED_CLIENT@crv_p01bobgi RC ON RC.client_group = CG.client_group_id
JOIN CRM_LITE.V_CRV_BKP_ACCOUNT@crv_p01bobgi A ON RC.customer = A.id;
